<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DSRT Image Editor - Lengkap Siap Pakai</title>
<style>
  /* Reset & base */
  * { box-sizing: border-box; }
  body, html { margin:0; padding:0; height:100vh; font-family: Poppins, sans-serif; background:#121212; color:#eee; }
  #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* Header */
  header {
    height: 50px; background:#222; display: flex; align-items:center; padding: 0 10px;
  }
  #backBtn {
    background:none; border:none; color:#0ff; font-size:24px; cursor:pointer; margin-right:10px;
  }
  #logo { font-weight:700; font-size: 20px; flex-grow:1; color:#0ff; }
  #menuToggle {
    background:none; border:none; color:#0ff; font-size:28px; cursor:pointer;
    display:none; /* only mobile */
  }
  @media(max-width:900px) {
    #menuToggle { display:inline-block; }
  }

  /* Main area */
  #main {
    flex-grow:1; display: flex; overflow: hidden;
  }

  /* Sidebar kiri */
  #sidebarLeft {
    width: 250px; background:#222; padding:10px; overflow-y: auto;
    transition: transform 0.3s ease;
  }
  #sidebarLeft.hide {
    transform: translateX(-260px);
  }
  #sidebarLeft h3 {
    margin-top:0; margin-bottom:10px; color:#0ff; border-bottom: 1px solid #0ff;
  }
  #sidebarLeft button.toolBtn {
    width: 100%; margin:5px 0; padding:8px; background:#333; border:none; color:#0ff; font-weight:600; cursor:pointer;
    border-radius: 4px;
    user-select:none;
    transition: background-color 0.3s;
  }
  #sidebarLeft button.toolBtn.active {
    background:#0ff; color:#222;
  }
  #closeSidebar {
    background:none; border:none; color:#f33; font-size: 28px; float:right; cursor:pointer;
  }

  /* Sidebar kanan */
  #sidebarRight {
    width: 250px; background:#222; padding:10px; overflow-y: auto;
    color:#0ff;
    transition: transform 0.3s ease;
  }
  #sidebarRight.hide {
    transform: translateX(260px);
  }
  #sidebarRight h3 {
    margin-top:0; margin-bottom:10px; border-bottom:1px solid #0ff;
  }
  #sidebarRight label {
    display:block; margin-top:10px;
  }
  #sidebarRight input[type=range] {
    width: 100%;
  }

  /* Canvas container */
  #canvasContainer {
    flex-grow:1; background:#111; display:flex; justify-content:center; align-items:center; position: relative;
    overflow: hidden;
    touch-action: none;
  }
  canvas {
    background:#222;
    max-width: 100%;
    max-height: 100%;
    user-select:none;
    touch-action:none;
    cursor: crosshair;
    image-rendering: pixelated;
    border-radius:4px;
  }

  /* Footer toolbar */
  footer {
    height: 50px; background:#222; display:flex; align-items:center; justify-content:center; gap:15px;
    padding:0 10px;
  }
  footer button {
    background:#0ff; border:none; padding:8px 12px; border-radius:4px; font-weight:700; cursor:pointer;
    color:#222;
    user-select:none;
    transition: background-color 0.3s;
  }
  footer button:disabled {
    background:#444; cursor:not-allowed; color:#888;
  }

  /* Upload button floating */
  #uploadBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background:#0ff;
    border:none;
    padding: 6px 12px;
    border-radius: 4px;
    font-weight: 600;
    color:#222;
    cursor:pointer;
  }
  #uploadInput {
    display:none;
  }

  /* Responsive */
  @media(max-width:900px){
    #sidebarLeft, #sidebarRight {
      position: fixed;
      top: 50px; bottom: 50px;
      z-index: 20;
      box-shadow: 2px 0 8px rgba(0,0,0,0.8);
      background:#222;
    }
    #sidebarLeft.hide {
      transform: translateX(-260px);
    }
    #sidebarRight.hide {
      transform: translateX(260px);
    }
    #menuToggle { display:inline-block; }
    #sidebarRight { right: 0; }
    #sidebarLeft { left: 0; }
    #canvasContainer {
      flex-grow:1; /* full area under header/footer */
    }
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <button id="backBtn" title="Back">&#8592;</button>
    <div id="logo">DSRT Image Editor</div>
    <button id="menuToggle" title="Toggle Menu">&#9776;</button>
  </header>
  <div id="main">
    <aside id="sidebarLeft" class="hide" aria-label="Sidebar tools">
      <button id="closeSidebar" title="Close Sidebar">&times;</button>
      <h3>Manual Tools</h3>
      <button class="toolBtn" data-tool="crop">Crop</button>
      <button class="toolBtn" data-tool="rotate">Rotate 90Â°</button>
      <button class="toolBtn" data-tool="brush">Brush</button>
      <button class="toolBtn" data-tool="eraser">Eraser</button>
      <h3>Restoration</h3>
      <button class="toolBtn" data-tool="spotHealing">Spot Healing</button>
      <button class="toolBtn" data-tool="cloneStamp">Clone Stamp</button>
      <h3>Filters</h3>
      <button class="toolBtn" data-tool="brightness">Brightness</button>
      <button class="toolBtn" data-tool="contrast">Contrast</button>
      <button class="toolBtn" data-tool="grayscale">Grayscale</button>
      <button class="toolBtn" data-tool="sepia">Sepia</button>
      <button class="toolBtn" data-tool="invert">Invert</button>
    </aside>

    <div id="canvasContainer" tabindex="0" aria-label="Image editing canvas">
      <input type="file" id="uploadInput" accept="image/*" />
      <button id="uploadBtn" title="Upload Image">Choose File</button>
      <canvas id="canvas" width="800" height="600"></canvas>
    </div>

    <aside id="sidebarRight" class="hide" aria-label="Tool properties">
      <h3>Properties</h3>
      <div id="toolProperties">Pilih tool dulu</div>
    </aside>
  </div>

  <footer>
    <button id="undoBtn" disabled>Undo</button>
    <button id="redoBtn" disabled>Redo</button>
    <button id="saveBtn" disabled>Save</button>
    <button id="exportBtn" disabled>Export</button>
  </footer>
</div>

<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // Elemen sidebar kanan properti
  const sidebarRight = document.getElementById('sidebarRight');
  const toolProperties = document.getElementById('toolProperties');

  // Undo/Redo Buttons
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');

  // Upload input & button
  const uploadInput = document.getElementById('uploadInput');
  const uploadBtn = document.getElementById('uploadBtn');

  // Sidebar toggle (mobile)
  const menuToggle = document.getElementById('menuToggle');
  const sidebarLeft = document.getElementById('sidebarLeft');
  const closeSidebar = document.getElementById('closeSidebar');

  // Tool buttons
  const toolButtons = document.querySelectorAll('#sidebarLeft button.toolBtn');

  // State gambar & tools
  let img = new Image();
  let imgLoaded = false;

  // Undo stack (simpan dataURL)
  const undoStack = [];
  const redoStack = [];
  const maxHistory = 20;

  // Tool aktif & parameter
  let currentTool = null;

  // Crop vars
  let cropStart = null;
  let cropEnd = null;
  let isCropping = false;

  // Brush parameter
  let brushSize = 15;

  // ----------------- Fungsi -------------------

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!imgLoaded) {
      ctx.fillStyle = '#222';
      ctx.font = '20px Poppins, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Upload gambar dulu', canvas.width / 2, canvas.height / 2);
      return;
    }
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    if (currentTool === 'crop' && cropStart && cropEnd) {
      ctx.strokeStyle = '#0ff';
      ctx.lineWidth = 2;
      const x = Math.min(cropStart.x, cropEnd.x);
      const y = Math.min(cropStart.y, cropEnd.y);
      const w = Math.abs(cropStart.x - cropEnd.x);
      const h = Math.abs(cropStart.y - cropEnd.y);
      ctx.strokeRect(x, y, w, h);
    }
  }

  function saveState() {
    if (!imgLoaded) return;
    if (undoStack.length >= maxHistory) undoStack.shift();
    undoStack.push(canvas.toDataURL());
    redoStack.length = 0;
    updateUndoRedo();
  }

  function restoreFromDataURL(dataURL) {
    const tmpImg = new Image();
    tmpImg.onload = () => {
      img = tmpImg;
      imgLoaded = true;
      draw();
      updateUndoRedo();
    };
    tmpImg.src = dataURL;
  }

  function undo() {
    if (undoStack.length > 1) {
      const last = undoStack.pop();
      redoStack.push(last);
      restoreFromDataURL(undoStack[undoStack.length - 1]);
    }
  }

  function redo() {
    if (redoStack.length > 0) {
      const redoData = redoStack.pop();
      undoStack.push(redoData);
      restoreFromDataURL(redoData);
    }
  }

  function updateUndoRedo() {
    undoBtn.disabled = undoStack.length <= 1;
    redoBtn.disabled = redoStack.length === 0;
    saveBtn.disabled = !imgLoaded;
    exportBtn.disabled = !imgLoaded;
  }

  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      const image = new Image();
      image.onload = () => {
        img = image;
        imgLoaded = true;
        let w = img.width;
        let h = img.height;
        const maxW = 800;
        const maxH = 600;
        if (w > maxW) {
          h = h * maxW / w;
          w = maxW;
        }
        if (h > maxH) {
          w = w * maxH / h;
          h = maxH;
        }
        canvas.width = w;
        canvas.height = h;
        draw();
        saveState();
      };
      image.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }

  // ---------------- Tool selection ----------------

  toolButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const selectedTool = btn.dataset.tool;
      if (currentTool === selectedTool) {
        currentTool = null;
        btn.classList.remove('active');
        sidebarRight.classList.add('hide');
        toolProperties.innerHTML = 'Pilih tool dulu';
      } else {
        currentTool = selectedTool;
        toolButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sidebarRight.classList.remove('hide');
        updatePropertiesPanel(selectedTool);
      }
      draw();
    });
  });

  function updatePropertiesPanel(tool) {
    let html = '';
    switch (tool) {
      case 'brush':
        html = `<label>Ukuran Brush: <input type="range" id="brushSize" min="1" max="50" value="${brushSize}"></label>`;
        break;
      case 'crop':
        html = `<p>Drag di canvas untuk memilih area crop, lalu klik <button id="applyCropBtn">Crop</button></p>`;
        break;
      case 'rotate':
        html = `<button id="rotateBtn">Putar 90Â°</button>`;
        break;
      case 'brightness':
      case 'contrast':
        html = `<label>${tool.charAt(0).toUpperCase() + tool.slice(1)}: <input type="range" id="${tool}Range" min="-100" max="100" value="0"></label>`;
        break;
      default:
        html = `<p>Atur properti jika ada.</p>`;
    }
    toolProperties.innerHTML = html;

    if (tool === 'brush') {
      document.getElementById('brushSize').addEventListener('input', e => {
        brushSize = +e.target.value;
      });
    }
    if (tool === 'crop') {
      document.getElementById('applyCropBtn').addEventListener('click', applyCrop);
    }
    if (tool === 'rotate') {
      document.getElementById('rotateBtn').addEventListener('click', rotateImage);
    }
    if (tool === 'brightness') {
      document.getElementById('brightnessRange').addEventListener('input', e => applyFilter('brightness', +e.target.value));
    }
    if (tool === 'contrast') {
      document.getElementById('contrastRange').addEventListener('input', e => applyFilter('contrast', +e.target.value));
    }
  }

  // ---------------- Canvas events ----------------

  let isDrawing = false;
  let lastPos = null;

  canvas.addEventListener('mousedown', e => {
    if (!imgLoaded) return;
    const pos = getCanvasPos(e);
    if (currentTool === 'crop') {
      cropStart = pos;
      cropEnd = null;
      isCropping = true;
      draw();
    } else if (currentTool === 'brush') {
      isDrawing = true;
      lastPos = pos;
    }
  });

  canvas.addEventListener('mousemove', e => {
    if (!imgLoaded) return;
    const pos = getCanvasPos(e);
    if (currentTool === 'crop' && isCropping) {
      cropEnd = pos;
      draw();
    }
    if (isDrawing && currentTool === 'brush') {
      drawLine(lastPos.x, lastPos.y, pos.x, pos.y);
      lastPos = pos;
    }
  });

  canvas.addEventListener('mouseup', e => {
    if (currentTool === 'crop' && isCropping) {
      cropEnd = getCanvasPos(e);
      isCropping = false;
      draw();
    }
    if (isDrawing && currentTool === 'brush') {
      isDrawing = false;
      lastPos = null;
      saveState();
    }
  });

  canvas.addEventListener('mouseleave', e => {
    if (isDrawing) {
      isDrawing = false;
      lastPos = null;
    }
  });

  function getCanvasPos(evt) {
    const rect = canvas.getBoundingClientRect();
    let x, y;
    if (evt.touches) {
      x = evt.touches[0].clientX - rect.left;
      y = evt.touches[0].clientY - rect.top;
    } else {
      x = evt.clientX - rect.left;
      y = evt.clientY - rect.top;
    }
    x = Math.max(0, Math.min(canvas.width, x));
    y = Math.max(0, Math.min(canvas.height, y));
    return { x, y };
  }

  function drawLine(x1, y1, x2, y2) {
    ctx.strokeStyle = '#0ff';
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  // ---------------- Tools -------------------

  function applyCrop() {
    if (!cropStart || !cropEnd) return alert('Pilih area crop dulu!');
    const x = Math.min(cropStart.x, cropEnd.x);
    const y = Math.min(cropStart.y, cropEnd.y);
    const w = Math.abs(cropStart.x - cropEnd.x);
    const h = Math.abs(cropStart.y - cropEnd.y);
    if (w < 10 || h < 10) return alert('Area crop terlalu kecil!');
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);
    img.src = tempCanvas.toDataURL();
    img.onload = () => {
      canvas.width = w;
      canvas.height = h;
      draw();
      saveState();
    };
    cropStart = cropEnd = null;
  }

  function rotateImage() {
    if (!imgLoaded) return;
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = img.height;
    tempCanvas.height = img.width;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
    tempCtx.rotate(Math.PI / 2);
    tempCtx.drawImage(img, -img.width / 2, -img.height / 2);
    img.src = tempCanvas.toDataURL();
    img.onload = () => {
      canvas.width = tempCanvas.width;
      canvas.height = tempCanvas.height;
      draw();
      saveState();
    };
  }

  function applyFilter(type, value) {
    if (!imgLoaded) return;
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    if (type === 'brightness') {
      for (let i = 0; i < data.length; i += 4) {
        data[i] = clamp(data[i] + value * 2.55);     // R
        data[i+1] = clamp(data[i+1] + value * 2.55); // G
        data[i+2] = clamp(data[i+2] + value * 2.55); // B
      }
    } else if (type === 'contrast') {
      const contrast = (value / 100) + 1;
      const intercept = 128 * (1 - contrast);
      for (let i = 0; i < data.length; i += 4) {
        data[i] = clamp(data[i] * contrast + intercept);
        data[i+1] = clamp(data[i+1] * contrast + intercept);
        data[i+2] = clamp(data[i+2] * contrast + intercept);
      }
    }
    ctx.putImageData(imageData, 0, 0);
    saveState();
  }

  function clamp(val) {
    return Math.max(0, Math.min(255, val));
  }

  // Filter presets

  function applyPresetFilter(filterName) {
    if (!imgLoaded) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.filter = 'none';

    switch (filterName) {
      case 'grayscale':
        ctx.filter = 'grayscale(100%)';
        break;
      case 'sepia':
        ctx.filter = 'sepia(100%)';
        break;
      case 'invert':
        ctx.filter = 'invert(100%)';
        break;
      default:
        ctx.filter = 'none';
    }
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    ctx.filter = 'none';
    saveState();
  }

  // Tool Buttons special handling for filters

  toolButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tool = btn.dataset.tool;
      if (['grayscale','sepia','invert'].includes(tool)) {
        applyPresetFilter(tool);
      }
    });
  });

  // Undo/Redo buttons event
  undoBtn.addEventListener('click', undo);
  redoBtn.addEventListener('click', redo);

  // Save (overwrite current state)
  saveBtn.addEventListener('click', () => {
    alert('Gambar sudah tersimpan di editor (undo history).');
  });

  // Export button (download PNG)
  exportBtn.addEventListener('click', () => {
    if (!imgLoaded) return;
    const link = document.createElement('a');
    link.download = 'dsrt-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  // Upload button open file dialog
  uploadBtn.addEventListener('click', () => uploadInput.click());
  uploadInput.addEventListener('change', handleFile);

  // Sidebar toggle for mobile
  menuToggle.addEventListener('click', () => {
    if (sidebarLeft.classList.contains('hide')) {
      sidebarLeft.classList.remove('hide');
    } else {
      sidebarLeft.classList.add('hide');
    }
  });
  closeSidebar.addEventListener('click', () => sidebarLeft.classList.add('hide'));

  // Initial draw
  draw();

})();
</script>
</body>
</html>
